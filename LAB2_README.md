# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 2: –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–í —ç—Ç–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–æ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:
- **users-api** - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **backend** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å—Ç–∞—Ç–µ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- **api-gateway** - Nginx –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Client ‚Üí API Gateway (Nginx:80) ‚Üí [ backend ] ‚Äî(own DB)‚Äî> articles, comments
                              ‚Üì
                              ‚Ü≥ [ users-api ] ‚Äî(own DB)‚Äî> users
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
project/
‚îú‚îÄ‚îÄ backend/                    # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (—Å—Ç–∞—Ç—å–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ articles.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ comments.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.py     # –ë–µ–∑ –º–æ–¥–µ–ª–∏ User
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ users_service/              # –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.py     # –¢–æ–ª—å–∫–æ –º–æ–¥–µ–ª—å User
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ nginx.conf                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API Gateway
‚îú‚îÄ‚îÄ docker-compose.yml          # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îî‚îÄ‚îÄ README.md
```

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
docker-compose up --build
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç:
- `db-main` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è backend
- `db-users` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è users-api
- `backend` - —Å–µ—Ä–≤–∏—Å —Å—Ç–∞—Ç–µ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- `users-api` - —Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `api-gateway` - Nginx –Ω–∞ –ø–æ—Ä—Ç—É 80

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

- **Users API**: `http://localhost/api/users`
- **Backend API**: `http://localhost/api/articles`
- **API Gateway**: `http://localhost`

## üîë –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. Data Ownership Pattern

- –í —Ç–∞–±–ª–∏—Ü–∞—Ö `articles` –∏ `comments` –ø–æ–ª–µ `author_id` –æ—Å—Ç–∞–ª–æ—Å—å, –Ω–æ **–±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞**
- –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ **JWT —Ç–æ–∫–µ–Ω**, –∞ –Ω–µ —á–µ—Ä–µ–∑ FK
- –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –≤–ª–∞–¥–µ–µ—Ç —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### 2. JWT Token

JWT —Ç–æ–∫–µ–Ω —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç `user_id`:
```json
{
  "sub": "user@example.com",
  "user_id": "uuid-here",
  "exp": 1234567890
}
```

### 3. API Gateway

Nginx –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã:
- `/api/users/*` ‚Üí `users-api:8000`
- `/api/user/*` ‚Üí `users-api:8000`
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí `backend:8000`

## üìù –ú–∏–≥—Ä–∞—Ü–∏–∏

### Backend –º–∏–≥—Ä–∞—Ü–∏–∏

1. `001_add_users.py` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü users –∏ articles (—Å—Ç–∞—Ä–∞—è)
2. `002_add_comments.py` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã comments
3. `003_add_foreign_keys.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ FK (—Å—Ç–∞—Ä–∞—è)
4. `004_remove_users_and_fk.py` - **—É–¥–∞–ª–µ–Ω–∏–µ FK –∏ —Ç–∞–±–ª–∏—Ü—ã users**

### Users Service –º–∏–≥—Ä–∞—Ü–∏–∏

1. `001_add_users.py` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–û–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π SECRET_KEY** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT:

```env
SECRET_KEY=your-secret-key-change-in-production
```

### –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- **Backend**: `postgresql://app:app@db-main:5432/app_main`
- **Users API**: `postgresql://app:app@db-users:5432/app_users`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
curl -X POST http://localhost/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "password123"
  }'
```

### 2. –í—Ö–æ–¥

```bash
curl -X POST http://localhost/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ `access_token` –∏–∑ –æ—Ç–≤–µ—Ç–∞.

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏

```bash
curl -X POST http://localhost/api/articles \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "title": "Test Article",
    "description": "Test Description",
    "body": "Test Body"
  }'
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **SECRET_KEY –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º** –≤ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT
2. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ `init_db.py`
3. **–ü–æ—Ä—Ç—ã**: –°–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ—Ä—Ç–∞—Ö, –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ API Gateway –Ω–∞ –ø–æ—Ä—Ç—É 80
4. **Health checks**: –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç health checks –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: JWT —Ç–æ–∫–µ–Ω –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `SECRET_KEY` –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö.

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω—ã –∏ –∑–¥–æ—Ä–æ–≤—ã:
```bash
docker-compose ps
```

### –ü—Ä–æ–±–ª–µ–º–∞: API Gateway –Ω–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx:
```bash
docker-compose logs api-gateway
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Docker Compose Networking](https://docs.docker.com/compose/networking/)
- [Nginx Reverse Proxy](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)
- [Microservices Data Ownership](https://microservices.io/patterns/data/database-per-service.html)

